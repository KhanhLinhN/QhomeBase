spring:
  cloud:
    gateway:
      routes:
        # Services Card Service Routes (priority - match first)
        - id: services-card-resident-card
          uri: ${services-card.service.url:http://localhost:8083}
          predicates:
            - Path=/api/resident-card/**
          filters:
            - StripPrefix=0
        - id: services-card-elevator-card
          uri: ${services-card.service.url:http://localhost:8083}
          predicates:
            - Path=/api/elevator-card/**
          filters:
            - StripPrefix=0
        - id: services-card-register-service
          uri: ${services-card.service.url:http://localhost:8083}
          predicates:
            - Path=/api/register-service/**
          filters:
            - StripPrefix=0
        - id: services-card-registrations
          uri: ${services-card.service.url:http://localhost:8083}
          predicates:
            - Path=/api/card-registrations/**
          filters:
            - StripPrefix=0
        - id: services-card-pricing
          uri: ${services-card.service.url:http://localhost:8083}
          predicates:
            - Path=/api/card-pricing/**
          filters:
            - StripPrefix=0
        # Services Card Service - Uploads (must be before base-service catch-all)
        - id: services-card-uploads
          uri: ${services-card.service.url:http://localhost:8083}
          predicates:
            - Path=/api/uploads/**
          filters:
            - StripPrefix=1
        # IAM Service Routes (must be before base-service catch-all)
        - id: iam-service
          uri: ${iam.service.url:http://localhost:8088}
          predicates:
            - Path=/api/iam/**
          filters:
            - RewritePath=/api/iam/(?<segment>.*), /api/$\{segment}  # Rewrite /api/iam/auth/login to /api/auth/login
        # Notifications Service Routes (must be before base-service catch-all)
        - id: notifications-service
          uri: ${customer-interaction.service.url:http://localhost:8086}
          predicates:
            - Path=/api/notifications/**
          filters:
            - StripPrefix=0
        # News Service Routes (must be before base-service catch-all)
        - id: news-service
          uri: ${customer-interaction.service.url:http://localhost:8086}
          predicates:
            - Path=/api/news/**
          filters:
            - StripPrefix=0
        # Asset Maintenance Service Routes (must be before base-service catch-all)
        - id: asset-maintenance-service
          uri: ${asset-maintenance.service.url:http://localhost:8084}
          predicates:
            - Path=/api/asset-maintenance/**
          filters:
            - StripPrefix=0
        # Finance Billing Service Routes (must be before base-service catch-all)
        - id: finance-billing-service
          uri: ${finance-billing.service.url:http://localhost:8085}
          predicates:
            - Path=/api/invoices/**,/api/billing/**
          filters:
            - StripPrefix=0
        # Data Docs Service Routes (must be before base-service catch-all)
        - id: data-docs-service
          uri: ${data-docs.service.url:http://localhost:8082}
          predicates:
            - Path=/api/data-docs/**
          filters:
            - StripPrefix=0
        # Data Docs Service - Contracts (must be before base-service catch-all)
        - id: data-docs-contracts
          uri: ${data-docs.service.url:http://localhost:8082}
          predicates:
            - Path=/api/contracts/**
          filters:
            - StripPrefix=0
        # Data Docs Service - Files (must be before base-service catch-all)
        - id: data-docs-files
          uri: ${data-docs.service.url:http://localhost:8082}
          predicates:
            - Path=/api/files/**
          filters:
            - StripPrefix=0
        # Customer Interaction Service Routes (must be before base-service catch-all)
        - id: customer-interaction-service
          uri: ${customer-interaction.service.url:http://localhost:8086}
          predicates:
            - Path=/api/customer-interaction/**
          filters:
            - StripPrefix=0
        # Marketplace Service Routes (must be before base-service catch-all)
        - id: marketplace-service
          uri: ${marketplace.service.url:http://localhost:8089}
          predicates:
            - Path=/api/marketplace/**
          filters:
            - StripPrefix=2
        # Chat Service Routes
        - id: chat-service
          uri: ${chat.service.url:http://localhost:8090}
          predicates:
            - Path=/api/chat/**
          filters:
            - StripPrefix=2
        # Staff Work Service Routes (must be before base-service catch-all)
        - id: staff-work-service
          uri: ${staff-work.service.url:http://localhost:8087}
          predicates:
            - Path=/api/staff-work/**
          filters:
            - StripPrefix=0
        # WebSocket Routes (must be before base-service catch-all)
        - id: websocket-customer-interaction
          uri: ${customer-interaction.service.url:http://localhost:8086}
          predicates:
            - Path=/ws/**
          filters:
            - StripPrefix=0
        # Health endpoint (must be before catch-all routes)
        - id: health-service
          uri: http://localhost:${server.port:8989}
          predicates:
            - Path=/api/health
          filters:
            - StripPrefix=0
        # Discovery endpoint (must be before catch-all routes)
        - id: discovery-service
          uri: http://localhost:${server.port:8989}
          predicates:
            - Path=/api/discovery/**
          filters:
            - StripPrefix=0
        # Base Service Routes (catch-all for /api/** - must be last)
        - id: base-service
          uri: ${base.service.url:http://localhost:8081}
          predicates:
            - Path=/api/**
          filters:
            - StripPrefix=0
      globalcors:
        corsConfigurations:
          '[/**]':
            allowedOriginPatterns: "*"  # Use allowedOriginPatterns instead of allowedOrigins when allowCredentials is true
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - PATCH
              - OPTIONS
            allowedHeaders: "*"
            allowCredentials: true
            maxAge: 3600

