{
  "info": {
    "name": "Meter Reading Workflow v2 - Full Flow",
    "_postman_id": "meter-reading-workflow-v2-001",
    "description": "Complete end-to-end workflow: Create Cycle → Assignment → Readings → Export → Invoices",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "auth": {
    "type": "bearer",
    "bearer": [
      {
        "key": "token",
        "value": "{{accessToken}}",
        "type": "string"
      }
    ]
  },
  "variable": [
    {
      "key": "baseUrl",
      "value": "http://localhost:8081",
      "type": "string",
      "description": "Base service URL"
    },
    {
      "key": "iamUrl",
      "value": "http://localhost:8088",
      "type": "string",
      "description": "IAM service URL"
    },
    {
      "key": "financeBillingUrl",
      "value": "http://localhost:8085",
      "type": "string",
      "description": "Finance billing service URL"
    }
  ],
  "item": [
    {
      "name": "0. Authentication",
      "item": [
        {
          "name": "Login - Admin",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const response = pm.response.json();",
                  "    pm.environment.set('accessToken', response.accessToken);",
                  "    if (response.userId) {",
                  "        pm.environment.set('userId', response.userId);",
                  "    }",
                  "    pm.test('Status is 200 OK', () => {",
                  "        pm.response.to.have.status(200);",
                  "    });",
                  "    pm.test('Response has access token', () => {",
                  "        pm.expect(response.accessToken).to.not.be.empty;",
                  "    });",
                  "    console.log('✅ Login successful! Access token saved.');",
                  "} else {",
                  "    console.log('❌ Login failed:', pm.response.json());",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "noauth"
            },
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"admin\",\n  \"password\": \"admin123\"\n}"
            },
            "url": {
              "raw": "{{iamUrl}}/api/auth/login",
              "host": ["{{iamUrl}}"],
              "path": ["api", "auth", "login"]
            },
            "description": "Login with admin credentials to get access token"
          },
          "response": []
        },
        {
          "name": "Login - Staff",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const response = pm.response.json();",
                  "    pm.environment.set('accessToken', response.accessToken);",
                  "    if (response.userId) {",
                  "        pm.environment.set('staffId', response.userId);",
                  "    }",
                  "    pm.test('Status is 200 OK', () => {",
                  "        pm.response.to.have.status(200);",
                  "    });",
                  "    console.log('✅ Staff login successful!');",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "auth": {
              "type": "noauth"
            },
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"staff\",\n  \"password\": \"staff123\"\n}"
            },
            "url": {
              "raw": "{{iamUrl}}/api/auth/login",
              "host": ["{{iamUrl}}"],
              "path": ["api", "auth", "login"]
            },
            "description": "Login with staff credentials"
          },
          "response": []
        }
      ]
    },
    {
      "name": "1. Setup - Get IDs",
      "item": [
        {
          "name": "Get All Services",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const services = pm.response.json();",
                  "    const electric = services.find(s => s.code === 'ELECTRIC');",
                  "    if (electric) {",
                  "        pm.environment.set('serviceId', electric.id);",
                  "        console.log('✅ ELECTRIC service ID:', electric.id);",
                  "    }",
                  "    const water = services.find(s => s.code === 'WATER');",
                  "    if (water) {",
                  "        pm.environment.set('waterServiceId', water.id);",
                  "        console.log('✅ WATER service ID:', water.id);",
                  "    }",
                  "    pm.test('Status is 200', () => {",
                  "        pm.response.to.have.status(200);",
                  "    });",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/services",
              "host": ["{{baseUrl}}"],
              "path": ["api", "services"]
            },
            "description": "Get all services and auto-save ELECTRIC and WATER service IDs"
          },
          "response": []
        },
        {
          "name": "Get All Buildings",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const response = pm.response.json();",
                  "    if (response.content && response.content.length > 0) {",
                  "        pm.environment.set('buildingId', response.content[0].id);",
                  "        console.log('✅ Building ID:', response.content[0].id);",
                  "    }",
                  "    pm.test('Status is 200', () => {",
                  "        pm.response.to.have.status(200);",
                  "    });",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/buildings",
              "host": ["{{baseUrl}}"],
              "path": ["api", "buildings"]
            },
            "description": "Get all buildings and auto-save first building ID"
          },
          "response": []
        },
        {
          "name": "Get Units by Building",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const response = pm.response.json();",
                  "    if (response.content && response.content.length > 0) {",
                  "        const firstUnit = response.content[0];",
                  "        pm.environment.set('unitId', firstUnit.id);",
                  "        if (firstUnit.household && firstUnit.household.residents && firstUnit.household.residents.length > 0) {",
                  "            pm.environment.set('residentId', firstUnit.household.residents[0].id);",
                  "        }",
                  "        console.log('✅ Unit ID:', firstUnit.id);",
                  "        console.log('✅ Resident ID:', pm.environment.get('residentId') || 'N/A');",
                  "    }",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/units?buildingId={{buildingId}}",
              "host": ["{{baseUrl}}"],
              "path": ["api", "units"],
              "query": [
                {
                  "key": "buildingId",
                  "value": "{{buildingId}}"
                }
              ]
            },
            "description": "Get units for the building and auto-save first unit and resident IDs"
          },
          "response": []
        },
        {
          "name": "Get Meters by Unit",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const meters = pm.response.json();",
                  "    if (meters && meters.length > 0) {",
                  "        const electricMeter = meters.find(m => m.serviceCode === 'ELECTRIC');",
                  "        if (electricMeter) {",
                  "            pm.environment.set('meterId', electricMeter.id);",
                  "            console.log('✅ Electric meter ID:', electricMeter.id);",
                  "        } else {",
                  "            pm.environment.set('meterId', meters[0].id);",
                  "            console.log('✅ Meter ID:', meters[0].id);",
                  "        }",
                  "    }",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/meters?unitId={{unitId}}",
              "host": ["{{baseUrl}}"],
              "path": ["api", "meters"],
              "query": [
                {
                  "key": "unitId",
                  "value": "{{unitId}}"
                }
              ]
            },
            "description": "Get meters for the unit and auto-save meter ID"
          },
          "response": []
        }
      ],
      "description": "Setup endpoints to get Service IDs, Building IDs, Unit IDs, Resident IDs, and Meter IDs"
    },
    {
      "name": "2. Create Reading Cycle",
      "item": [
        {
          "name": "Create Reading Cycle",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 201) {",
                  "    const response = pm.response.json();",
                  "    pm.environment.set('cycleId', response.id);",
                  "    pm.test('Status is 201 Created', () => {",
                  "        pm.response.to.have.status(201);",
                  "    });",
                  "    pm.test('Response has cycleId', () => {",
                  "        pm.expect(response.id).to.not.be.empty;",
                  "    });",
                  "    pm.test('Status is OPEN', () => {",
                  "        pm.expect(response.status).to.equal('OPEN');",
                  "    });",
                  "    console.log('✅ Cycle created with ID:', response.id);",
                  "    console.log('  Period:', response.periodFrom, 'to', response.periodTo);",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"Tháng 1/2024\",\n  \"periodFrom\": \"2024-01-01\",\n  \"periodTo\": \"2024-01-31\",\n  \"description\": \"Kỳ đọc điện nước tháng 1\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/reading-cycles",
              "host": ["{{baseUrl}}"],
              "path": ["api", "reading-cycles"]
            },
            "description": "Create a new reading cycle for January 2024"
          },
          "response": []
        },
        {
          "name": "Get Reading Cycle By ID",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status is 200', () => {",
                  "    pm.response.to.have.status(200);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/reading-cycles/{{cycleId}}",
              "host": ["{{baseUrl}}"],
              "path": ["api", "reading-cycles", "{{cycleId}}"]
            }
          },
          "response": []
        }
      ]
    },
    {
      "name": "3. Create Assignment",
      "item": [
        {
          "name": "Create Assignment - Electric",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 201) {",
                  "    const response = pm.response.json();",
                  "    pm.environment.set('assignmentId', response.id);",
                  "    pm.test('Status is 201 Created', () => {",
                  "        pm.response.to.have.status(201);",
                  "    });",
                  "    pm.test('Response has assignmentId', () => {",
                  "        pm.expect(response.id).to.not.be.empty;",
                  "    });",
                  "    console.log('✅ Assignment created with ID:', response.id);",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"cycleId\": \"{{cycleId}}\",\n  \"buildingId\": \"{{buildingId}}\",\n  \"serviceId\": \"{{serviceId}}\",\n  \"assignedTo\": \"{{staffId}}\",\n  \"startDate\": \"2024-01-06\",\n  \"endDate\": \"2024-01-10\",\n  \"note\": \"Đọc điện tòa A tầng 1-10\",\n  \"floorFrom\": 1,\n  \"floorTo\": 10\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/meter-reading-assignments",
              "host": ["{{baseUrl}}"],
              "path": ["api", "meter-reading-assignments"]
            },
            "description": "Create assignment for electric meter reading"
          },
          "response": []
        },
        {
          "name": "Get Meters By Assignment",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const meters = pm.response.json();",
                  "    console.log('✅ Found ' + meters.length + ' meters in assignment scope');",
                  "    if (meters.length > 0 && !pm.environment.get('meterId')) {",
                  "        pm.environment.set('meterId', meters[0].id);",
                  "    }",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/meter-reading-assignments/{{assignmentId}}/meters",
              "host": ["{{baseUrl}}"],
              "path": ["api", "meter-reading-assignments", "{{assignmentId}}", "meters"]
            },
            "description": "Get list of meters in assignment scope"
          },
          "response": []
        }
      ]
    },
    {
      "name": "3.5. Create Session",
      "item": [
        {
          "name": "Start Session",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 201) {",
                  "    const response = pm.response.json();",
                  "    pm.environment.set('sessionId', response.id);",
                  "    pm.test('Status is 201 Created', () => {",
                  "        pm.response.to.have.status(201);",
                  "    });",
                  "    pm.test('Response has sessionId', () => {",
                  "        pm.expect(response.id).to.not.be.empty;",
                  "    });",
                  "    pm.test('Session status is ACTIVE', () => {",
                  "        pm.expect(response.status).to.equal('ACTIVE');",
                  "    });",
                  "    console.log('✅ Session created with ID:', response.id);",
                  "    console.log('  Assignment ID:', response.assignmentId);",
                  "    console.log('  Status:', response.status);",
                  "} else {",
                  "    console.log('❌ Failed to create session:', pm.response.json());",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"assignmentId\": \"{{assignmentId}}\",\n  \"deviceInfo\": \"Postman Test Device\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/meter-reading-sessions",
              "host": ["{{baseUrl}}"],
              "path": ["api", "meter-reading-sessions"]
            },
            "description": "Start a new meter reading session for the assignment"
          },
          "response": []
        },
        {
          "name": "Get Session By ID",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status is 200', () => {",
                  "    pm.response.to.have.status(200);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/meter-reading-sessions/{{sessionId}}",
              "host": ["{{baseUrl}}"],
              "path": ["api", "meter-reading-sessions", "{{sessionId}}"]
            },
            "description": "Get session details by ID"
          },
          "response": []
        },
        {
          "name": "Get My Active Session",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const response = pm.response.json();",
                  "    if (response && response.id) {",
                  "        pm.environment.set('sessionId', response.id);",
                  "        console.log('✅ Active session found:', response.id);",
                  "    }",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/meter-reading-sessions/my-active-session",
              "host": ["{{baseUrl}}"],
              "path": ["api", "meter-reading-sessions", "my-active-session"]
            },
            "description": "Get my active session (if exists)"
          },
          "response": []
        },
        {
          "name": "Complete Session",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const response = pm.response.json();",
                  "    pm.test('Session is completed', () => {",
                  "        pm.expect(response.completedAt).to.not.be.null;",
                  "    });",
                  "    console.log('✅ Session completed successfully');",
                  "    console.log('  Completed at:', response.completedAt);",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "PATCH",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/meter-reading-sessions/{{sessionId}}/complete",
              "host": ["{{baseUrl}}"],
              "path": ["api", "meter-reading-sessions", "{{sessionId}}", "complete"]
            },
            "description": "Complete the session (optional - can export without completing)"
          },
          "response": []
        }
      ],
      "description": "Create and manage meter reading sessions"
    },
    {
      "name": "4. Create Meter Readings",
      "item": [
        {
          "name": "Create Meter Reading",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 201) {",
                  "    const response = pm.response.json();",
                  "    pm.environment.set('meterReadingId', response.id);",
                  "    if (response.sessionId) {",
                  "        pm.environment.set('sessionId', response.sessionId);",
                  "    }",
                  "    pm.test('Status is 201 Created', () => {",
                  "        pm.response.to.have.status(201);",
                  "    });",
                  "    pm.test('Response has meterReadingId', () => {",
                  "        pm.expect(response.id).to.not.be.empty;",
                  "    });",
                  "    pm.test('Response has consumption', () => {",
                  "        pm.expect(response.consumption).to.be.a('number');",
                  "    });",
                  "    console.log('✅ Meter reading created with ID:', response.id);",
                  "    console.log('  Consumption:', response.consumption, 'kWh');",
                  "    console.log('  Previous index:', response.prevIndex, 'kWh');",
                  "    console.log('  Current index:', response.currIndex, 'kWh');",
                  "    if (response.sessionId) {",
                  "        console.log('  Session ID:', response.sessionId);",
                  "    }",
                  "} else {",
                  "    console.log('❌ Failed to create meter reading:', pm.response.json());",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"assignmentId\": \"{{assignmentId}}\",\n  \"sessionId\": \"{{sessionId}}\",\n  \"meterId\": \"{{meterId}}\",\n  \"readingDate\": \"2024-01-15\",\n  \"currIndex\": 250.5,\n  \"note\": \"Đọc điện tầng 5\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/meter-readings",
              "host": ["{{baseUrl}}"],
              "path": ["api", "meter-readings"]
            },
            "description": "Create a meter reading. prevIndex and readerId are optional - service auto-calculates prevIndex and gets readerId from auth"
          },
          "response": []
        },
        {
          "name": "Create Multiple Meter Readings",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 201) {",
                  "    const response = pm.response.json();",
                  "    console.log('✅ Created meter reading:', response.id);",
                  "    if (response.sessionId && !pm.environment.get('sessionId')) {",
                  "        pm.environment.set('sessionId', response.sessionId);",
                  "    }",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"assignmentId\": \"{{assignmentId}}\",\n  \"sessionId\": \"{{sessionId}}\",\n  \"meterId\": \"{{meterId}}\",\n  \"readingDate\": \"2024-01-15\",\n  \"currIndex\": 350.0,\n  \"note\": \"Reading 2 - same session\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/meter-readings",
              "host": ["{{baseUrl}}"],
              "path": ["api", "meter-readings"]
            },
            "description": "Create another reading in the same session"
          },
          "response": []
        },
        {
          "name": "Get Readings by Session (Verify)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const readings = pm.response.json();",
                  "    console.log('✅ Found ' + readings.length + ' readings in session');",
                  "    if (readings.length === 0) {",
                  "        console.warn('⚠️ WARNING: No readings found in session!');",
                  "        console.warn('⚠️ Make sure to create readings AFTER creating session');",
                  "        console.warn('⚠️ Use sessionId in the meter reading request');",
                  "    } else {",
                  "        readings.forEach((r, i) => {",
                  "            console.log(`  Reading ${i+1}: ${r.meterCode || 'N/A'} - ${r.currIndex || 'N/A'} kWh`);",
                  "        });",
                  "    }",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/meter-readings?sessionId={{sessionId}}",
              "host": ["{{baseUrl}}"],
              "path": ["api", "meter-readings"],
              "query": [
                {
                  "key": "sessionId",
                  "value": "{{sessionId}}"
                }
              ]
            },
            "description": "Verify readings exist in session before exporting. IMPORTANT: Create readings AFTER creating session and use sessionId!"
          },
          "response": []
        }
      ],
      "description": "Create meter readings. ⚠️ IMPORTANT: Create readings AFTER creating session and include sessionId in request body!"
    },
    {
      "name": "5. Export Readings to Finance-Billing",
      "item": [
        {
          "name": "Export Readings by Session",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const response = pm.response.json();",
                  "    pm.test('Status is 200 OK', () => {",
                  "        pm.response.to.have.status(200);",
                  "    });",
                  "    pm.test('Response has invoice data', () => {",
                  "        pm.expect(response).to.have.property('totalReadings');",
                  "        pm.expect(response).to.have.property('invoicesCreated');",
                  "        pm.expect(response).to.have.property('invoiceIds');",
                  "    });",
                  "    pm.environment.set('totalReadings', response.totalReadings);",
                  "    pm.environment.set('invoicesCreated', response.invoicesCreated);",
                  "    pm.environment.set('invoiceIds', JSON.stringify(response.invoiceIds));",
                  "    if (response.invoiceIds && response.invoiceIds.length > 0) {",
                  "        pm.environment.set('invoiceId', response.invoiceIds[0]);",
                  "        console.log('✅ Invoice created with ID:', response.invoiceIds[0]);",
                  "    }",
                  "    if (response.totalReadings === 0) {",
                  "        console.warn('⚠️ WARNING: No readings found in session!');",
                  "        console.warn('⚠️ Possible reasons:');",
                  "        console.warn('  1. Readings were created BEFORE session was created');",
                  "        console.warn('  2. Readings were created with sessionId = null');",
                  "        console.warn('  3. Session ID is incorrect');",
                  "        console.warn('⚠️ SOLUTION: Create readings AFTER creating session and use sessionId!');",
                  "    } else {",
                  "        console.log('✅ Exported ' + response.totalReadings + ' readings');",
                  "        console.log('✅ Created ' + response.invoicesCreated + ' invoices');",
                  "        console.log('Invoice IDs:', response.invoiceIds);",
                  "    }",
                  "} else {",
                  "    console.log('❌ Failed to export readings:', pm.response.json());",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{accessToken}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/meter-readings/export/session/{{sessionId}}",
              "host": ["{{baseUrl}}"],
              "path": ["api", "meter-readings", "export", "session", "{{sessionId}}"]
            },
            "description": "Export all meter readings from a session to finance-billing-service and create invoices automatically. ⚠️ IMPORTANT: Make sure readings were created AFTER session was created and include sessionId in the meter reading request!"
          },
          "response": []
        },
        {
          "name": "Export Readings by Cycle",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const response = pm.response.json();",
                  "    pm.test('Status is 200 OK', () => {",
                  "        pm.response.to.have.status(200);",
                  "    });",
                  "    pm.test('Response has invoice data', () => {",
                  "        pm.expect(response).to.have.property('totalReadings');",
                  "        pm.expect(response).to.have.property('invoicesCreated');",
                  "        pm.expect(response).to.have.property('invoiceIds');",
                  "    });",
                  "    pm.environment.set('totalReadings', response.totalReadings);",
                  "    pm.environment.set('invoicesCreated', response.invoicesCreated);",
                  "    pm.environment.set('invoiceIds', JSON.stringify(response.invoiceIds));",
                  "    if (response.invoiceIds && response.invoiceIds.length > 0) {",
                  "        pm.environment.set('invoiceId', response.invoiceIds[0]);",
                  "        console.log('✅ Invoice created with ID:', response.invoiceIds[0]);",
                  "    }",
                  "    console.log('✅ Exported ' + response.totalReadings + ' readings');",
                  "    console.log('✅ Created ' + response.invoicesCreated + ' invoices');",
                  "    console.log('Invoice IDs:', response.invoiceIds);",
                  "} else {",
                  "    console.log('❌ Failed to export readings:', pm.response.json());",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{accessToken}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/meter-readings/export/cycle/{{cycleId}}",
              "host": ["{{baseUrl}}"],
              "path": ["api", "meter-readings", "export", "cycle", "{{cycleId}}"]
            },
            "description": "Export all completed meter readings from a cycle to finance-billing-service and create invoices automatically"
          },
          "response": []
        }
      ],
      "description": "Export meter readings from base-service to finance-billing-service. This triggers automatic invoice creation."
    },
    {
      "name": "6. Query Invoices",
      "item": [
        {
          "name": "Get Invoice By ID",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const response = pm.response.json();",
                  "    pm.test('Status is 200 OK', () => {",
                  "        pm.response.to.have.status(200);",
                  "    });",
                  "    pm.test('Invoice has lines', () => {",
                  "        pm.expect(response.lines).to.be.an('array');",
                  "        pm.expect(response.lines.length).to.be.above(0);",
                  "    });",
                  "    pm.test('Invoice has total amount', () => {",
                  "        pm.expect(response.totalAmount).to.be.a('number');",
                  "    });",
                  "    console.log('✅ Invoice Code:', response.code);",
                  "    console.log('✅ Invoice Status:', response.status);",
                  "    console.log('✅ Invoice Lines:', response.lines.length);",
                  "    console.log('✅ Total Amount:', response.totalAmount, response.currency);",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{accessToken}}"
              }
            ],
            "url": {
              "raw": "{{financeBillingUrl}}/api/invoices/{{invoiceId}}",
              "host": ["{{financeBillingUrl}}"],
              "path": ["api", "invoices", "{{invoiceId}}"]
            },
            "description": "Get invoice details by ID"
          },
          "response": []
        },
        {
          "name": "Get All Invoices by Service Code (ELECTRIC)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const response = pm.response.json();",
                  "    console.log('✅ Found ' + response.length + ' electric invoices');",
                  "    response.forEach((invoice, index) => {",
                  "        console.log(`Invoice ${index + 1}: ${invoice.code} - ${invoice.totalAmount} ${invoice.currency}`);",
                  "    });",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{accessToken}}"
              }
            ],
            "url": {
              "raw": "{{financeBillingUrl}}/api/invoices/service/ELECTRIC",
              "host": ["{{financeBillingUrl}}"],
              "path": ["api", "invoices", "service", "ELECTRIC"]
            },
            "description": "Get all invoices for ELECTRIC service"
          },
          "response": []
        },
        {
          "name": "Get All Invoices by Service Code (WATER)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{accessToken}}"
              }
            ],
            "url": {
              "raw": "{{financeBillingUrl}}/api/invoices/service/WATER",
              "host": ["{{financeBillingUrl}}"],
              "path": ["api", "invoices", "service", "WATER"]
            },
            "description": "Get all invoices for WATER service"
          },
          "response": []
        },
        {
          "name": "Get Invoices by Unit",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const response = pm.response.json();",
                  "    console.log('✅ Found ' + response.length + ' invoices for unit');",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{accessToken}}"
              }
            ],
            "url": {
              "raw": "{{financeBillingUrl}}/api/invoices/unit/{{unitId}}",
              "host": ["{{financeBillingUrl}}"],
              "path": ["api", "invoices", "unit", "{{unitId}}"]
            },
            "description": "Get all invoices for a specific unit"
          },
          "response": []
        },
        {
          "name": "Get Invoices by Resident and Service",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{accessToken}}"
              }
            ],
            "url": {
              "raw": "{{financeBillingUrl}}/api/invoices/resident/{{residentId}}/service/ELECTRIC",
              "host": ["{{financeBillingUrl}}"],
              "path": ["api", "invoices", "resident", "{{residentId}}", "service", "ELECTRIC"]
            },
            "description": "Get all ELECTRIC invoices for a specific resident"
          },
          "response": []
        }
      ],
      "description": "Query invoices created from exported meter readings"
    }
  ]
}
